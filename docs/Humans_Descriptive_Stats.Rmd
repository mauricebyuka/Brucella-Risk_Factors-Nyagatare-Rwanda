
```{r setup, message = FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Load necessary libraries

```{r message = FALSE, warning = FALSE}
library(tidyverse)
library(scales)
library(ggplot2)
```

### Read the dataset

```{r}
database <- read.csv('../data/Humans_raw_Combined_Data.csv')
variables <- read.csv('../data/Human_data_variables.csv')
```

## DATA CLEANING


###  Let's split the database into analysis dataframes

This will allow us to create subdatasets for the high risk groups: veterinarians and butchers.

```{r}
all_variables <- variables$all_entries
all_data <- database %>% select(all_of(all_variables))
dim(all_data)

# Make a sub-dataset for butchers
butcher_variables <- variables$butchers[1:11]
butchers <- database %>% filter(Professions == "Butcher or works at a slaughterhouse")

butchers <- butchers %>% select(all_of(butcher_variables))
dim(butchers)

# Make a sub-dataset for veterinarians
vet_variables <- variables$vets[1:6]
vetData <- database %>% filter(Professions == "Veterinarian / para-veterinarian")
vetData <- vetData %>% select(all_of(vet_variables))
dim(vetData)
```


### Group profession categories for easy analysis

```{r}
all_data <- all_data %>% mutate(
  OccupGroup = case_when(
    Occupation == "Teacher" ~ "others", 
    Occupation == "Security officer" ~ "others", 
    Occupation == "None" ~ "others", 
    Occupation == "Retired" ~ "others", 
    Occupation == "Officer worker" ~ "others",
    Occupation == "Student" ~ "others",
    Occupation == "Farm assistant" ~ "livestock farmers", 
    Occupation == "Farmer" ~ "livestock farmers",
    Occupation == "livestock trader" ~ "livestock farmers",
    Occupation == "MCC worker" ~ "milk handlers",
    Occupation == "Milk transporter" ~ "milk handlers",
    Occupation == "Butcher" ~ "meat handlers",
    Occupation == "Slaughterhouse worker" ~ "meat handlers",
    .default = Occupation),
  .after = Occupation
)

all_data <- all_data %>% select(-Occupation) 
```

### Prep data for regression analyis

```{r}
# Remove varibles that are not useful for regression analysis
all_data <- all_data %>% mutate_if(is.character, as.factor)
all_data <- all_data %>% select(-c("Date", "Form_ID", "Latitude", "Longitude", "Sampling_area", "Cell", "Village", "District"))
# str(all_data)

# Removing variables with unbalanced levels
all_data <- all_data %>% select(-c("Sleeping_with_animals", "Cheese"))

#Removing symptom variables (we can re-introduce them leter as a separate analysis together with pregancy and miscarriage information)
rfData <- all_data %>% select(-c("fever", "Night_Sweats", "Fatigue", "Joint_pain", "Swollen_joints", "Muscular_pain", "Back_pain", "Headaches", "Loss_of_appetite", "fever_time", "fever_type", "Fever_duration", "Seek_health_care_If_feve", "Hospitalized", "Recovered"))

## Removing Placeholder variables and RBT )
rfData <- rfData  %>% select(-c("female", "pregrant", "live_births", "miscarrage_or_stillbirths", "RBT")) #rfData = Dataset for risk factors
# table(rfData$OccupGroup)
```

### Output the clean dataset to be used for the next step: Regression Analysis

```{r}
# Set "livestock farmers" as the reference occupation category
rfData$OccupGroup = relevel(rfData$OccupGroup, ref = "livestock farmers")
colnames(rfData)

# Write data to a file.

write.csv(rfData, '../output/Humans_regression_data.csv', row.names = FALSE)
```


## DESCRIPTIVE STATISTICS

### Convert ELISA Result to a Factor
```{r}
data <- rfData
data$ELISA <- factor(data$ELISA, levels = c("Negative", "Positive"))
```

### Calculate Prevalence
```{r, message=FALSE, warning=FALSE}
prevalence <- data %>% 
  count(ELISA) %>% 
  mutate(Percentage = n / sum(n) * 100)
prevalence
```

### Plot Prevalence
```{r, message=FALSE, warning=FALSE}
ggplot(prevalence, aes(x = ELISA, y = Percentage, fill = ELISA)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = paste0(round(Percentage, 1), "%")), vjust = 0.5, position = position_stack(vjust = 0.5)) +
  labs(title = "Prevalence of Brucellosis", x = "ELISA Result", y = "Percentage (%)") +
  theme_minimal()
```

### Summary Statistics for Age
```{r, message=FALSE, warning=FALSE}
age_summary <- data %>% 
  group_by(Age) %>% 
  summarise(Count = n(), Percentage = Count / nrow(data) * 100)
age_summary
```

### Plot Age Distribution
```{r, message=FALSE, warning=FALSE}
ggplot(data, aes(x = Age)) +
  geom_bar(fill = "skyblue") +
  geom_text(stat = "count", aes(label = paste0(..count.., " (", round(..count.. / sum(..count..) * 100, 1), "%", ")")), vjust = 0.5, position = position_stack(vjust = 0.5)) +
  labs(title = "Age Distribution of Participants", x = "Age Group", y = "Count") +
  theme_minimal()
```

### Gender Distribution
```{r, message=FALSE, warning=FALSE}
gender_summary <- data %>% 
  group_by(Gender) %>% 
  summarise(Count = n(), Percentage = Count / nrow(data) * 100)
gender_summary
```

### Plot Gender Distribution
```{r, message=FALSE, warning=FALSE}
ggplot(data, aes(x = Gender)) +
  geom_bar(fill = "lightgreen") +
  geom_text(stat = "count", aes(label = paste0(..count.., " (", round(..count.. / sum(..count..) * 100, 1), "%", ")")), vjust = 0.5, position = position_stack(vjust = 0.5)) +
  labs(title = "Gender Distribution of Participants", x = "Gender", y = "Count") +
  theme_minimal()
```

### Occupational Group Distribution
```{r, message=FALSE, warning=FALSE}
occup_group_summary <- data %>% 
  group_by(OccupGroup) %>% 
  summarise(Count = n(), Percentage = Count / nrow(data) * 100)
occup_group_summary
```

### Plot Occupational Group Distribution
```{r, message=FALSE, warning=FALSE}
ggplot(data, aes(x = OccupGroup)) +
  geom_bar(fill = "orange") +
  geom_text(stat = "count", aes(label = paste0(..count.., " (", round(..count.. / sum(..count..) * 100, 1), "%", ")")), vjust = 0.5, position = position_stack(vjust = 0.5)) +
  labs(title = "Occupational Group Distribution", x = "Occupational Group", y = "Count") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Contact with Waste vs ELISA Result
```{r, message=FALSE, warning=FALSE}
contact_vs_elisa <- data %>% 
  group_by(contact_with_waste, ELISA) %>% 
  summarise(Count = n()) %>% 
  group_by(contact_with_waste) %>% 
  mutate(Percentage = Count / sum(Count) * 100)
contact_vs_elisa
```

### Plot Contact with Waste vs ELISA Result
```{r, message=FALSE, warning=FALSE}
ggplot(data, aes(x = contact_with_waste, fill = ELISA)) +
  geom_bar(position = "fill") +
  geom_text(stat = "count", aes(label = paste0(..count.., " (", round(..count.. / tapply(..count.., ..x.., sum)[..x..] * 100, 1), "%", ")")), position = position_fill(vjust = 0.5)) +
  labs(title = "Contact with Waste vs ELISA Result", x = "Contact with Waste", y = "Proportion", fill = "ELISA Result") +
  theme_minimal()
```

### Plots for Other Variables vs ELISA Result
```{r, message=FALSE, warning=FALSE}
variables <- c("Age", "Gender", "OccupGroup", "Marital_status", "Education", "parturition", "aborted_fetus", "milking", "Herded_livestock", "Slaughtered", "boiled_milk", "Raw_milk")

for (var in variables) {
  p <- ggplot(data, aes_string(x = var, fill = "ELISA")) +
    geom_bar(position = "fill") +
    geom_text(stat = "count", aes(label = paste0(..count.., " (", round(..count.. / tapply(..count.., ..x.., sum)[..x..] * 100, 1), "%", ")")), position = position_fill(vjust = 0.5)) +
    labs(title = paste("ELISA Result vs", var, "in Livestock"), x = var, y = "Proportion", fill = "ELISA Result") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  print(p)
}
```

