---
title: "Seroprevalence and Risk Factors of Human Brucellosis in Nyatatare Disrict of Rwanda"
author: "Maurice Byukusenge"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, message = FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This document contains the code used for assessing the risk factors associated with Brucellosis in the Nyagatare district of Rwanda. The results of this analysis have been published in the ............. journal. This code and associated data are made available to readers who would like to reproduce the results presented in the publication. 


### Load necessary libraries

```{r message = FALSE, warning = FALSE}
library(dplyr)      # For data wrangling when necessary
library(ggplot2)    # For data visualization
library(broom)      # For making tidy tibles from stats objects
library(boot)       # For cross-validation analysis
library(pROC)       # For ROC curve
library(tidyr)      # For changing the shape of data
library(car)        # For VIF calculation (multicollinearity)
library(MASS)       # For stepwise model selection
library(gtsummary)  # Cleaner table of the model summary
```

### Read the dataset

```{r}
data <- read.csv('../output/Livestock_regression_data.csv') # Output of the previous step
```

### Convert categorical variables to factors and set reference categories for saome variables.

All the other variables will keep their default reference categories. For example, all Yes or No variables have "No" as their ref category.

```{r}
data <-data %>% mutate_if(is.character, as.factor)

# Set reference categories for some variables
data$Breed <- relevel(data$Breed, ref = 'Local')
data$aborted_animal_fate <- relevel(data$aborted_animal_fate, ref = 'Not applicable')
data$Age <- relevel(data$Age, ref = 'Young')

```


### Function to calculate odds ratios, confidence intervals, and p-values

```{r}
calculate_results <- function(model) {
  results <- tidy(model, conf.int = TRUE) %>%
    mutate(odds_ratio = exp(estimate),
           lower_ci = exp(conf.low),
           upper_ci = exp(conf.high),
           p.value = p.value,  # Do not round p-values
           odds_ratio = round(odds_ratio, 2),
           lower_ci = round(lower_ci, 2),
           upper_ci = round(upper_ci, 2)) %>%
    select(term, odds_ratio, lower_ci, upper_ci, p.value) %>%
  return(results)
}
```

### Univariable Logistic Regression

```{r}
risk_factors <- c('sector', 'herd_size_cattle', 'herd_size_sheep', 'Herdsizegoats', 
                  'animals_live_with_people', 'farm_fenced', 'wildlife_interaction', 
                  'shared_water', 'breeding_methods', 'having_vet', 'animalFeedAbort', 
                  'throwingAbort', 'new_introduction', 'brucellosis_awareness', 
                  'species', 'Breed', 'Age', 'Sex')

univariable_results <- list()

for (factor in risk_factors) {
  formula <- as.formula(paste("ELISA_sample ~", factor))
  model <- glm(formula, data = data, family = "binomial")
  univariable_results[[factor]] <- calculate_results(model)
}

# Combine all univariable results into one table
univariable_results_df <- bind_rows(univariable_results, .id = "Factor")
write.csv(univariable_results_df, "Livestock_univariable_results_with_ci.csv", row.names = FALSE)

```

### Multivariable Logistic Regression

```{r}
# Multivariable Logistic Regression (before stepwise selection)
initial_model <- glm(ELISA_sample ~ sector + herd_size_cattle + herd_size_sheep + 
                       Herdsizegoats + animals_live_with_people + farm_fenced + 
                       wildlife_interaction + shared_water + breeding_methods + 
                       having_vet + animalFeedAbort + throwingAbort + new_introduction + 
                       brucellosis_awareness + species + Breed + Age + Sex + 
                       aborted_animal_fate + buryingAbort,  # Add missing variables
                     data = data, family = "binomial")

print(summary(initial_model))

```

```{r}
# Remove variables with estimate signs that don't make sense
initial_model <- update(initial_model, . ~ . - new_introduction - wildlife_interaction - animals_live_with_people - 
                          brucellosis_awareness)

```

```{r}
# Perform multicollinearity assessment using VIF on the fitted logistic regression model
vif_values <- vif(initial_model)  # Calculate VIF for all predictors in the model
print(vif_values)
```

### Model secltion

```{r, message=FALSE, warning=FALSE, results='hide'}
# Perform stepwise model selection based on AIC
stepwise_model <- stepAIC(initial_model, direction = "both", trace = FALSE)
```

```{r}
# Print the final selected model
tbl_regression(stepwise_model, exponentiate = TRUE)
```


```{r}

# Get the multivariable results with odds ratios, confidence intervals, and p-values
multivariable_results_df <- calculate_results(stepwise_model)

# Save the results to a CSV file
write.csv(multivariable_results_df, "multivariable_results_with_ci.csv", row.names = FALSE)
```

### Model Performance Evaluation

```{r}
# Cross-validation (10-fold) using cv.glm from the boot package
set.seed(123)
cv_results <- cv.glm(data, stepwise_model, K=10)
print(cv_results$delta)  # Cross-validation prediction error

# ROC Curve and AUC
predictions <- predict(stepwise_model, newdata = data, type = "response")
roc_curve <- roc(data$ELISA_sample, predictions)

# Plot ROC Curve
plot(roc_curve, main = "ROC Curve for Brucellosis Prediction Model", col = "blue")
auc_value <- auc(roc_curve)
print(paste("AUC: ", auc_value))

```

### Vusulasation of Regression Anlaysis Results

```{r}
# Odds Ratios from the final model for visualization
odds_data <- multivariable_results_df %>%
  filter(odds_ratio != "-") %>%
  mutate(odds_ratio = as.numeric(odds_ratio),
         significant = ifelse(p.value < 0.05, "Significant", "Non-significant"))

# Create a forest plot (odds ratios with confidence intervals)
ggplot(odds_data, aes(x = term, y = odds_ratio, ymin = lower_ci, ymax = upper_ci, color = significant)) +
  geom_pointrange() +  # Add points and error bars for confidence intervals
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +  # Reference line at OR=1
  coord_flip() +
  theme_minimal() +
  labs(x = 'Risk Factors', y = 'Odds Ratios', title = 'Forest Plot of Odds Ratios with 95% Confidence Intervals') +
  scale_color_manual(values = c("Significant" = "skyblue", "Non-significant" = "gray")) +  # Custom colors for significant vs. non-significant
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```





